---
platform: windows

inputs:
- name: edge-windows-binary-32
- name: edge-windows-binary-64
- name: cli-ci

outputs:
- name: extracted-binaries

params:
  TARGET_V7:

run:
  path: powershell.exe
  args:
  - -command
  - |
    # Print current directory & contents to make debugging easier, for we cannot hijack, but we can `cd`
    Get-ChildItem

    if ($TARGET_V7 -eq "true") {
      Set-Variable Suffix "7"
    } else {
      Set-Variable Suffix ""
    }

    Expand-Archive -LiteralPath .\edge-windows-binary-32\cf-cli_edge_win32.zip
    Expand-Archive -LiteralPath .\edge-windows-binary-64\cf-cli_edge_winx64.zip

    & 'C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\signtool.exe' `
      sign `
      /t http://timestamp.sectigo.com `
      /n "Cloudfoundry.org Foundation, Inc" `
      .\cf-cli_edge_win32\cf.exe
    Move-Item .\cf-cli_edge_win32\cf.exe .\extracted-binaries\cf${Suffix}-cli_win32.exe

    & 'C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\signtool.exe' `
      sign `
      /t http://timestamp.sectigo.com `
      /n "Cloudfoundry.org Foundation, Inc" `
      .\cf-cli_edge_winx64\cf.exe
    Move-Item .\cf-cli_edge_winx64\cf.exe .\extracted-binaries\cf${Suffix}-cli_winx64.exe
